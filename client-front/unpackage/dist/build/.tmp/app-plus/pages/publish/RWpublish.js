(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/publish/RWpublish"],{"13ba":function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=s(n("a34a")),a=s(n("0f13")),u=s(n("f1ed"));function s(t){return t&&t.__esModule?t:{default:t}}function c(t,e,n,i,a,u,s){try{var c=t[u](s),r=c.value}catch(o){return void n(o)}c.done?e(r):Promise.resolve(r).then(i,a)}function r(t){return function(){var e=this,n=arguments;return new Promise(function(i,a){var u=t.apply(e,n);function s(t){c(u,i,a,s,r,"next",t)}function r(t){c(u,i,a,s,r,"throw",t)}s(void 0)})}}var o=function(){return n.e("components/uni-icon/uni-icon").then(n.bind(null,"ee5a"))},l=[["camera"],["album"],["camera","album"]],d={components:{uniIcon:o},data:function(){return{index_grade:0,index_subject:0,picker_subject:["语文","数学","英语","物理","化学","生物","政治","历史","地理"],picker_grade:["小学1年级","小学2年级","小学3年级","小学4年级","小学5年级","小学6年级","初中1年级","初中2年级","初中3年级","高中1年级","高中2年级","高中3年级"],imageList:[],index_img:0,modalName:null,price:0,sizeTypeIndex:1,sizeType:["压缩","原图","压缩或原图"],sourceTypeIndex:2,sourceType:["拍照","相册","拍照或相册"],textareaAValue:"",textContent:"",imgList:[],taskId:"",publishing:!1}},onShow:function(){this.checkLogin(),a.default.getBalance()},methods:{textareaAInput:function(t){this.textareaAValue=t.detail.value},changePrice:function(t){this.price=t.detail.value},PickerChangeSubject:function(t){this.index_subject=t.detail.value},PickerChangeGrade:function(t){this.index_grade=t.detail.value},ChooseImage:function(){var e=this;t.chooseImage({count:9-this.imgList.length,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){0!=e.imgList.length?e.imgList=e.imgList.concat(t.tempFilePaths):e.imgList=t.tempFilePaths}})},ViewImage:function(e){t.previewImage({urls:this.imgList,current:e.currentTarget.dataset.url})},DelImg:function(t){this.imgList.splice(t.currentTarget.dataset.index,1)},checkLogin:function(){t.getStorageSync("account")},publish:function(){var e=this;this.publishing=!0;var n={account:t.getStorageSync("account"),descText:this.textareaAValue,subject:this.index_subject,grade:this.index_grade,reward:this.price};this.validation().then(function(){e.RWajax.post("/task/publish",n).then(function(n){1==n.data.success?(e.taskId=n.data.result,e.uploadImg()):(e.publishing=!1,t.showToast({title:"出错",icon:"none"}))})}).catch(function(t){e.publishing=!1})},uploadImgSingle:function(e,n){var i=this;return new Promise(function(a,u){var s;t.getImageInfo({src:e,success:function(c){s=c.type,t.uploadFile({url:i.$host+"/file/upload",filePath:e,name:"file",formData:{fileName:"task/"+n.taskId+"/"+n.position,fileType:s},success:function(e){var s=JSON.parse(e.data);if(1==s.success){var c=s.result;t.request({url:i.$host+"/picture/upload",method:"post",data:[{linkerId:n.taskId,position:n.position,url:c}],success:function(t){a(c)},fail:function(t){u(t)}})}else t.showModal({content:"请求失败，请重试",showCancel:!1}),u(e)},fail:function(e){t.showModal({content:e.errMsg,showCancel:!1}),u(e)}})}})})},uploadImgAll:function(){var t=r(i.default.mark(function t(){var e,n,a;return i.default.wrap(function(t){while(1)switch(t.prev=t.next){case 0:e=this,n=[],a=0;case 3:if(!(a<this.imgList.length)){t.next=10;break}return t.next=6,e.uploadImgSingle(e.imgList[a],{taskId:e.taskId,position:a});case 6:n[a]=t.sent;case 7:a++,t.next=3;break;case 10:return t.abrupt("return",n);case 11:case"end":return t.stop()}},t,this)}));function e(){return t.apply(this,arguments)}return e}(),uploadImg:function(){var e=this,n=this;this.imgList;t.showLoading({title:"任务发布中..."}),0==this.imgList.length?(t.hideLoading(),t.showToast({title:"任务发布成功",icon:"success",duration:1e3}),setTimeout(function(){this.publishing=!1,t.navigateBack({delta:1})},1e3)):n.uploadImgAll().then(function(){t.showToast({title:"任务发布成功",icon:"success",duration:1e3}),setTimeout(function(){t.navigateBack({delta:1})},1e3)}).catch(function(e){t.showToast({title:"任务发布失败，请重试",icon:"none",duration:1e3})}).finally(function(){t.hideLoading(),e.publishing=!1})},checkPermission:function(){var e=r(i.default.mark(function e(n){var a,s;return i.default.wrap(function(e){while(1)switch(e.prev=e.next){case 0:if(a=n?n-1:this.sourceTypeIndex,!u.default.isIOS){e.next=7;break}return e.next=4,u.default.requestIOS(l[a][0]);case 4:e.t0=e.sent,e.next=10;break;case 7:return e.next=9,u.default.requestAndroid(0===a?"android.permission.CAMERA":"android.permission.READ_EXTERNAL_STORAGE");case 9:e.t0=e.sent;case 10:return s=e.t0,null===s||1===s?s=1:t.showModal({content:"没有开启权限",confirmText:"设置",success:function(t){t.confirm&&u.default.gotoAppSetting()}}),e.abrupt("return",s);case 13:case"end":return e.stop()}},e,this)}));function n(t){return e.apply(this,arguments)}return n}(),validation:function(){var e=r(i.default.mark(function e(){var n,a=this;return i.default.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return n={account:t.getStorageSync("account"),descText:this.textareaAValue,subject:this.index_subject,grade:this.index_grade,reward:this.price},e.abrupt("return",new Promise(function(e,i){""==a.textareaAValue.trim()?(t.showToast({title:"任务描述不能为空",icon:"none"}),i("任务描述不能为空")):n.reward>t.getStorageSync("balance")?(t.showModal({title:"金币不足",content:"剩余金币(".concat(t.getStorageSync("balance")||0,")不足以发布任务,点击确认前往充值"),success:function(e){e.confirm&&t.navigateTo({url:"../recharge/RWrechart/RWrechart"})}}),i("余额不足")):e()}));case 2:case"end":return e.stop()}},e,this)}));function n(){return e.apply(this,arguments)}return n}(),handleTextInput:function(t){this.textContent=t.detail.value},handleImageRmove:function(t){t>-1&&this.imageList.splice(t,1)}},onNavigationBarButtonTap:function(){}};e.default=d}).call(this,n("6e42")["default"])},"59f2":function(t,e,n){"use strict";var i=n("6271"),a=n.n(i);a.a},6271:function(t,e,n){},"7c8e":function(t,e,n){"use strict";n.r(e);var i=n("13ba"),a=n.n(i);for(var u in i)"default"!==u&&function(t){n.d(e,t,function(){return i[t]})}(u);e["default"]=a.a},"820b":function(t,e,n){"use strict";n.r(e);var i=n("fc53"),a=n("7c8e");for(var u in a)"default"!==u&&function(t){n.d(e,t,function(){return a[t]})}(u);n("59f2");var s=n("2877"),c=Object(s["a"])(a["default"],i["a"],i["b"],!1,null,null,null);e["default"]=c.exports},ba1f:function(t,e,n){"use strict";(function(t){n("85c2"),n("921b");i(n("66fd"));var e=i(n("820b"));function i(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,n("6e42")["createPage"])},fc53:function(t,e,n){"use strict";var i=function(){var t=this,e=t.$createElement;t._self._c},a=[];n.d(e,"a",function(){return i}),n.d(e,"b",function(){return a})}},[["ba1f","common/runtime","common/vendor"]]]);